name: CI

on:
  push:
    branches: [ main, develop, "claude/**" ]
  pull_request:
    branches: [ main, develop ]

jobs:
  lint:
    name: Lint Code
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Check for package.json
        id: check_package
        run: |
          if [ -f package.json ]; then
            echo "has_package=true" >> $GITHUB_OUTPUT
          else
            echo "has_package=false" >> $GITHUB_OUTPUT
          fi

      - name: Install dependencies
        if: steps.check_package.outputs.has_package == 'true'
        run: npm ci

      - name: Run linter
        if: steps.check_package.outputs.has_package == 'true'
        run: npm run lint --if-present

  validate-structure:
    name: Validate Project Structure
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check required files
        run: |
          echo "Checking for required documentation files..."

          # Required files
          required_files=(
            "README.md"
            "LICENSE"
            "docs/ARCHITECTURE.md"
            "docs/INVARIANTS.md"
            "docs/ROADMAP.md"
            "docs/DECISIONS.md"
            "prompts/README.md"
            "prompts/engineering.md"
          )

          missing_files=()

          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "❌ Missing: $file"
              missing_files+=("$file")
            else
              echo "✅ Found: $file"
            fi
          done

          if [ ${#missing_files[@]} -gt 0 ]; then
            echo ""
            echo "Error: Missing required files:"
            printf '%s\n' "${missing_files[@]}"
            exit 1
          fi

          echo ""
          echo "✅ All required files present"

  validate-invariants:
    name: Validate Code Against Invariants
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for Uint8Array usage (INV-API-002)
        run: |
          echo "Checking for consistent Uint8Array usage..."

          # Check for potential violations of INV-API-002 (Uint8Array for binary data)
          # This is a basic check - can be expanded

          if grep -r "new Array" *.js 2>/dev/null | grep -i "usb\|binary\|buffer" ; then
            echo "⚠️  Warning: Found potential Array usage where Uint8Array might be needed"
            echo "   Review code to ensure INV-API-002 compliance"
          else
            echo "✅ No obvious violations of binary data type usage"
          fi

      - name: Check for WebUSB availability checks (INV-CONS-001)
        run: |
          echo "Checking for WebUSB availability checks..."

          # Look for direct navigator.usb usage without checking availability
          if grep -r "navigator\.usb\." *.js *.html 2>/dev/null | grep -v "navigator\.usb)" | head -5; then
            echo ""
            echo "⚠️  Reminder: Ensure WebUSB availability is checked (INV-CONS-001)"
            echo "   Review code for proper feature detection"
          fi

      - name: Check for vendor ID filtering (INV-SEC-001)
        run: |
          echo "Checking for USB device filtering..."

          # Basic check for requestDevice calls
          if grep -r "requestDevice" *.js *.html 2>/dev/null; then
            echo ""
            echo "✅ Found USB device requests - verify vendor/product ID filters are in place (INV-SEC-001)"
          fi

  test:
    name: Run Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Check for package.json
        id: check_package
        run: |
          if [ -f package.json ]; then
            echo "has_package=true" >> $GITHUB_OUTPUT
          else
            echo "has_package=false" >> $GITHUB_OUTPUT
          fi

      - name: Install dependencies
        if: steps.check_package.outputs.has_package == 'true'
        run: npm ci

      - name: Run tests
        if: steps.check_package.outputs.has_package == 'true'
        run: npm test --if-present

      - name: Note for future
        if: steps.check_package.outputs.has_package == 'false'
        run: |
          echo "⚠️  No package.json found - tests will be added in Phase 2"
          echo "   See ROADMAP.md for testing infrastructure plans"

  build:
    name: Build Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Check for package.json
        id: check_package
        run: |
          if [ -f package.json ]; then
            echo "has_package=true" >> $GITHUB_OUTPUT
          else
            echo "has_package=false" >> $GITHUB_OUTPUT
          fi

      - name: Install dependencies
        if: steps.check_package.outputs.has_package == 'true'
        run: npm ci

      - name: Run build
        if: steps.check_package.outputs.has_package == 'true'
        run: npm run build --if-present

      - name: Validate JavaScript syntax
        run: |
          echo "Validating JavaScript files..."
          for file in *.js; do
            if [ -f "$file" ]; then
              node --check "$file" && echo "✅ $file" || echo "❌ $file"
            fi
          done

          # Check .mjs files
          for file in *.mjs; do
            if [ -f "$file" ]; then
              node --check "$file" && echo "✅ $file" || echo "❌ $file"
            fi
          done

  android-build:
    name: Android Build Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for Android project
        id: check_android
        run: |
          if [ -d "android-app" ]; then
            echo "has_android=true" >> $GITHUB_OUTPUT
          else
            echo "has_android=false" >> $GITHUB_OUTPUT
          fi

      - name: Set up JDK 17
        if: steps.check_android.outputs.has_android == 'true'
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Android SDK
        if: steps.check_android.outputs.has_android == 'true'
        uses: android-actions/setup-android@v3

      - name: Grant execute permission for gradlew
        if: steps.check_android.outputs.has_android == 'true'
        run: chmod +x android-app/gradlew

      - name: Build Android project
        if: steps.check_android.outputs.has_android == 'true'
        working-directory: android-app
        run: ./gradlew assembleDebug --no-daemon

      - name: Run Android lint
        if: steps.check_android.outputs.has_android == 'true'
        working-directory: android-app
        run: ./gradlew lint --no-daemon
        continue-on-error: true

  documentation:
    name: Documentation Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate documentation links
        run: |
          echo "Checking for broken internal documentation links..."

          # Check if referenced files in markdown exist
          # This is a basic check - can be expanded

          broken_links=()

          for md_file in docs/*.md prompts/*.md README.md; do
            if [ -f "$md_file" ]; then
              echo "Checking $md_file..."

              # Look for markdown links to local files
              # This is a simplified check
              grep -o '\[.*\](\.\.*/.*\.md)' "$md_file" 2>/dev/null || true
            fi
          done

          echo "✅ Documentation structure validated"

      - name: Check for TODO markers
        run: |
          echo "Checking for [TBD] markers in documentation..."

          tbd_count=$(grep -r "\[TBD\]" docs/ prompts/ README.md 2>/dev/null | wc -l || echo "0")

          echo "Found $tbd_count [TBD] markers"

          if [ "$tbd_count" -gt 0 ]; then
            echo "⚠️  Documentation has items marked [TBD] - consider addressing these"
            grep -n "\[TBD\]" docs/*.md prompts/*.md README.md 2>/dev/null || true
          else
            echo "✅ No [TBD] markers found"
          fi

  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [lint, validate-structure, validate-invariants, test, build, android-build, documentation]
    if: always()

    steps:
      - name: Check overall status
        run: |
          echo "CI Pipeline Summary"
          echo "==================="
          echo ""
          echo "✅ All checks completed"
          echo ""
          echo "Note: This is Phase 1 CI - basic validation only"
          echo "Phase 2 will add comprehensive testing and coverage"
          echo ""
          echo "See ROADMAP.md for planned CI/CD improvements"
